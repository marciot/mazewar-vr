<!--
MazeWars VR
Copyright (C) 2016 Marcio Teixeira

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU Affero General Public License
as published by the Free Software Foundation; either version 3
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Maze Tester</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
            h1 {
                text-align: center;
            }

            #maze {
                border-collapse: collapse;
                margin:          2em;
            }

            #maze td {
                position:    relative;
                width:       30px;
                height:      30px;
                border:      1px dotted lightGray;
            }

            td.filled {
                background-color: black;
            }

            .sprite {
                position: absolute;
                top:      0;
                bottom:   0;
                left:     0;
                right:    0;
                opacity:  0.75;
                text-align:  center;
                font-size:   20px;
            }
            .sprite.robotPlayer {color: red;}
            .sprite.selfPlayer  {color: green;}
            .sprite.netPlayer   {color: blue;}
            .sprite.missile     {color: orange;}

            button, input {
                margin-top:    5px;
                margin-bottom: 5px;
            }

            button:first-child {
                margin-left: 105px;
            }

            label {
                font-weight: bold;
                display:     inline-block;
                width:       100px;
                text-align:  right;
                padding-right: 5px;
            }

            #controls {
                display:         -ms-flex;
                display:         -webkit-flex;
                display:         flex;

                flex-direction:  row;
                justify-content: space-around;
            }

            #touchControls {
                text-align: center;
            }

            #touchControls TABLE {
                margin: 0 auto;
            }

            #touchControls TD {
                font-size: 125%;
                width:     1.25em;
                height:    1.25em;
                padding:   5px 5px;
            }

            #touchForward, #touchBackward, #touchLeft, #touchRight, #touchCenter, #touchUTurn {
                border:     1px solid black;
                background: lightGray;
                cursor:     pointer;
            }
        </style>
        <script type="text/javascript" src="../js/Directions.js"></script>
        <script type="text/javascript" src="../js/Maze.js"></script>
        <script type="text/javascript" src="../js/Actors.js"></script>
        <script type="text/javascript" src="../js/Directors.js"></script>
        <script type="text/javascript" src="../js/GameMaster.js"></script>

        <script type="text/javascript" src="../js/third-party/peerjs/peer-modified.js"></script>
        <script type="text/javascript" src="../js/networking/frame-utilities.js"></script>
        <script type="text/javascript" src="../js/networking/pup-services.js"></script>
        <script type="text/javascript" src="../js/networking/pup-services-mazewar.js"></script>
        <script type="text/javascript" src="../js/networking/retroweb-network.js"></script>
        <script type="text/javascript" src="../js/networking/cordova-setup.js"></script>

        <script type="text/javascript" src="../js/third-party/yconsole-compiled.js"></script>
        <script type="text/javascript">
        /*window.onerror = function(error) {
            YConsole.show();
        };
        YConsole.activate();
        YConsole.docking="bottom";*/
        </script>
    </head>
    <body>
        <h1>Maze Tester</h1>

        <table id="maze">
        </table>

        <div id="controls">
            <div>
                <h3>Keyboard Controls:</h3>
                <ul>
                    <li>a: About face
                    <li>s: Turn left
                    <li>d: Move forwards
                    <li>f: Turn right
                    <li>c: Move backwards
                </ul>
            </div>

            <div id="touchControls">
                <h3>Touch Controls:</h3>
                <table>
                    <tr>
                        <td></td>
                        <td id="touchForward">&#9650;</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td id="touchLeft">&#9664;</td>
                        <td id="touchCenter">&#11044;</td>
                        <td id="touchRight">&#9654;</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td id="touchBackward">&#9660;</td>
                        <td id="touchUTurn">&#10227;</td>
                    </tr>
                </table>
            </div>

            <div>
                <h3>Networking Controls:</h3>
                <p>
                    <label>Player Name</label><input type="text" id="playerName" value="alice"><br>
                    <label>Host ID</label><input type="number" id="hostId" size="2" min="1" max="255"><br>
                    <span>
                        <button id="startGameButton" onclick="startGame()">Start Game</button>
                        <button onclick="YConsole.show()">Console</button>
                    </span>
                <p>
            </div>
        </div>
    </body>
    <script>
        const sprites = {
            NORTH: "&#11014;",
            EAST:  "&#10145;",
            SOUTH: "&#11015;",
            WEST:  "&#11013;",
            DEAD:   "&#10006;"
        };

        class MazeRepresentation {
            constructor(tableEl, maze) {
                tableEl.innerHTML = "";
                for(var y = 0; y < maze.mazeRows; y++) {
                    var rowEl = document.createElement("tr");
                    for(var x = 0; x < maze.mazeCols; x++) {
                        var cellEl = document.createElement("td");
                        cellEl.id = this.cellId(x,y);
                        if(maze.getCell(x,y)) {
                            cellEl.className = "filled";
                        }
                        rowEl.appendChild(cellEl);
                    }
                    tableEl.appendChild(rowEl);
                }
            }

            cellId(x,y) {
                return "cell" + x + "_" + y;
            }

            moveSpriteToCell(x, y, dom) {
                var cellEl = document.getElementById(this.cellId(x,y));
                if(cellEl) {
                    cellEl.appendChild(dom);
                } else {
                    console.log("Invalid sprite location", x, y);
                }
            }
        }

        class PlayerRepresentation {
            constructor(type) {
                this.dir = Directions.NORTH;
                this.callback = null;

                this.dom = document.createElement("div");
                this.dom.className = "sprite " + type;
                this.type = type;
            }

            setSpriteToArrow() {
                var text = "";
                switch(this.dir) {
                    case Directions.NORTH: text=sprites.NORTH; break;
                    case Directions.EAST:  text=sprites.EAST; break;
                    case Directions.SOUTH: text=sprites.SOUTH; break;
                    case Directions.WEST:  text=sprites.WEST; break;
                }
                this.dom.innerHTML = text;
            }

            setAnimationFinishedCallback(callback) {
                this.callback = callback;
            }

            shotDead(respawnCallback) {
                this.dom.innerHTML = sprites.DEAD;
                setTimeout(respawnCallback, 1000);
            }

            respawn() {
                this.setSpriteToArrow();
            }

            setPosition(x, z) {
                mazeRep.moveSpriteToCell(x, z, this.dom);
            }

            walkTo(x, z, direction) {
                mazeRep.moveSpriteToCell(x, z, this.dom);
                this.scheduleCallback();
            }

            orientTowards(direction) {
                this.turnTowards(direction);
            }

            turnTowards(direction) {
                this.dir = direction;
                this.setSpriteToArrow();
                this.scheduleCallback();
            }

            timerCallback() {
                this.timer = null;
                if(this.callback) {
                    this.callback();
                }
            }

            scheduleCallback() {
                if(!this.timer) {
                    this.timer = setTimeout(this.timerCallback.bind(this), 1000);
                }
            }

            startAnimation() {
                this.scheduleCallback();
            }

            dispose() {
                this.dom.remove();
                this.callback = null;
            }

            getMissileRepresentation() {
                return new PlayerRepresentation("missile");
            }

            get cardinalDirection() {
                return this.dir;
            }

            set name(name) {
                this.dom.title = name;
            }
        };

        var self;
        document.getElementById("touchLeft").addEventListener("click", function(e) {self.turnLeft();});
        document.getElementById("touchRight").addEventListener("click", function(e) {self.turnRight();});
        document.getElementById("touchForward").addEventListener("click", function(e) {self.walk();});
        document.getElementById("touchBackward").addEventListener("click", function(e) {self.walkBackwards();});
        document.getElementById("touchUTurn").addEventListener("click", function(e) {self.aboutFace();});

        var actors  = new Actors();
        var maze    = new Maze();
        var mazeRep = new MazeRepresentation(document.querySelector("#maze"), maze);

        /* Suggest a random hostId */
        const ETHERNET_ADDR_MIN       = 0x01;
        const ETHERNET_ADDR_MAX       = 0xFF;

        var playerNameField = document.getElementById("playerName");
        var hostIdField = document.getElementById("hostId");
        hostIdField.value = Math.floor(Math.random() * (ETHERNET_ADDR_MAX - ETHERNET_ADDR_MIN)) + ETHERNET_ADDR_MIN;

        var playerFactory = {
            newSelfPlayer: function() {
                var actor = new Player(new PlayerRepresentation("selfPlayer"));
                actors.placePlayer(actor);
                new KeyboardDirector(actor);
                self = actor;
                return actor;
            },
            newRobotPlayer: function() {
                var actor = new Player(new PlayerRepresentation("robotPlayer"));
                actors.placePlayer(actor);
                new RoboticDirector(actor);
                return actor;
            },
            newOtherPlayer: function() {
                var actor = new Player(new PlayerRepresentation("netPlayer"));
                actors.placePlayer(actor);
                return actor;
            }
        };

        var gameMaster = new SoloGame(playerFactory);
        gameMaster.startGame();

        function startGame() {
            if(!playerNameField.value) {
                return;
            }
            hostIdField.disabled = true;
            playerNameField.disabled  = true;

            gameMaster.endGame();
            gameMaster = new NetworkedGame(playerFactory);

            gameMaster.startGame(
                parseInt(hostIdField.value),
                playerNameField.value,
                function stateChangedCallback(state) {
                    document.getElementById("startGameButton").innerText = state;
                }
            );
        }
    </script>
    <!--
        I host SDK keys in a separate web server so they don't end up on GitHub.
        If you forked this project, you should generate your own API keys.
    -->
    <script crossorigin="anonymous" type="text/javascript" src="http://marciot.freeshell.org/sdk-keys/sdk-keys-mazewar-vr.js"></script>
    <script>
        if(typeof RetroWeb.peerJSConfig === "undefined") {
            alert("For full functionality, provide your own API keys for Peer.js");
        }
    </script>
</html>